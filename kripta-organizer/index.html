<p>
  <a href="./docs/REGISTRO-KRIPTA-v1.md" target="_blank">
    Registro Declarativo Público do Sistema Kripta
  </a>
</p>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Kripta-Organizer — v0.8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1 class="app-header">
  <div class="header-top">
    <div class="header-left">
      <span class="logo">K</span>
      <span class="corp-name">KriptaCorp</span>
      <span class="product-name">Kripta-Organizer</span>
    </div>

    <div class="header-right">
      <button class="manual-btn" onclick="location.href='manual.html'">
        Manual de instruções
      </button>

      <div class="mvp-links">
        <button>Kripta-Agenda</button>
        <button>Kripta-Timer</button>
        <button>Kripta-Focus</button>
        <button>Kripta-thermoSENSE</button>
        <button>Kripta-Bússola</button>
        <button>Kripta-Site</button>
      </div>
    </div>
  </div>

  <div class="header-slogan">
    … eles pedem para você organizar. O Kripta-Organizer já vem organizado
  </div>
</h1>

<div style="margin-bottom:10px;">
  <button id="back">← Voltar</button>
  <span id="context" style="margin-left:10px;color:#aaa;"></span>
</div>

<div style="margin-bottom:10px;">
  <button id="new">+ Nova Nota</button>
  <button id="open-history">Histórico</button>
  <button id="export-all">Exportar Tudo</button>
  <button id="export-one">Exportar Nota Aberta</button>
  <button id="import">Importar JSON</button>
</div>

<input id="search" type="text" placeholder="Buscar…" style="width:100%;margin-bottom:16px;" />

<div class="editor-layout">

  <section class="editor-panel">
    <h2>Editor</h2>
    <input id="title" type="text" placeholder="Título" style="width:100%;margin-bottom:6px;" />
    <textarea id="editor" placeholder="Digite aqui..." style="width:100%;"></textarea>

    <div style="margin-top:10px;">
      <button id="archive">Arquivar</button>
      <button id="delete" style="background:#3a0000;">Excluir definitivamente</button>
    </div>
  </section>

  <aside class="context-panel">
    <h3>Contexto da Unidade</h3>

    <div class="context-item"><label>Título</label><div id="ctx-title">—</div></div>
    <div class="context-item"><label>Estado</label><div id="ctx-state">—</div></div>
    <div class="context-item"><label>Caminho</label><div id="ctx-path">—</div></div>
    <div class="context-item"><label>Criada em</label><div id="ctx-created">—</div></div>
    <div class="context-item"><label>Última edição</label><div id="ctx-updated">—</div></div>
    <div class="context-item"><label>Subunidades</label><div id="ctx-children">—</div></div>

    <div class="context-item">
      <label>Última unidade editada (memória)</label>
      <div id="ctx-last-edited">—</div>
    </div>
  </aside>

</div>

<div style="margin:16px 0;">
  Ordenar:
  <select id="sort">
    <option value="az">Título (A–Z)</option>
    <option value="za">Título (Z–A)</option>
    <option value="new">Mais recentes</option>
    <option value="old">Mais antigas</option>
  </select>
</div>

<ul id="list"></ul>
<input id="file" type="file" accept="application/json" style="display:none" />

<script src="kernel.js"></script>
<script>
const STORAGE_LAST_EDITED = "kripta:lastEditedUnitId";

const list = document.getElementById("list");
const title = document.getElementById("title");
const editor = document.getElementById("editor");
const contextLabel = document.getElementById("context");

const btnNew = document.getElementById("new");
const btnBack = document.getElementById("back");
const btnArchive = document.getElementById("archive");
const btnDelete = document.getElementById("delete");
const btnHistory = document.getElementById("open-history");

const search = document.getElementById("search");
const sort = document.getElementById("sort");

let currentId = null;
let currentContext = "root";
let sortMode = "az";
let searchQuery = "";

function getVisibleUnits() {
  let units = kernel.getUnits(currentContext);

  if (searchQuery.trim()) {
    const q = searchQuery.toLowerCase();
    units = units.filter(u =>
      (u.title || "").toLowerCase().includes(q) ||
      (u.content || "").toLowerCase().includes(q)
    );
  }

  units.sort((a, b) => {
    if (sortMode === "az") return (a.title || "").localeCompare(b.title || "");
    if (sortMode === "za") return (b.title || "").localeCompare(a.title || "");
    if (sortMode === "new") return (b.updatedAt || 0) - (a.updatedAt || 0);
    if (sortMode === "old") return (a.updatedAt || 0) - (b.updatedAt || 0);
    return 0;
  });

  return units;
}

function render() {
  list.innerHTML = "";

  getVisibleUnits().forEach(u => {
    const li = document.createElement("li");
    li.textContent = u.title || "(sem título)";
    li.onclick = () => open(u.id);
    list.appendChild(li);
  });

  if (currentContext === "root") {
    contextLabel.textContent = "ROOT";
    btnBack.disabled = true;
  } else {
    const u = kernel.getUnit(currentContext);
    contextLabel.textContent = u?.title || "(sem título)";
    btnBack.disabled = false;
  }
}

function renderContextPanel(unit) {
  if (!unit) return;

  document.getElementById("ctx-title").textContent = unit.title || "(sem título)";
  document.getElementById("ctx-state").textContent = unit.state;
  document.getElementById("ctx-created").textContent = new Date(unit.createdAt).toLocaleString();
  document.getElementById("ctx-updated").textContent = new Date(unit.updatedAt).toLocaleString();
  document.getElementById("ctx-path").textContent =
    kernel.getPath ? kernel.getPath(unit.id).join(" › ") : unit.title || "ROOT";
  document.getElementById("ctx-children").textContent = kernel.getUnits(unit.id).length;
}

function open(id) {
  const u = kernel.getUnit(id);
  if (!u) return;

  currentId = id;
  currentContext = id;

  title.value = u.title || "";
  editor.value = u.content || "";
  btnArchive.textContent = u.state === "ARQUIVADO" ? "Desarquivar" : "Arquivar";

  localStorage.setItem(STORAGE_LAST_EDITED, id);
  renderLastEditedUnit();

  renderContextPanel(u);
  render();
}

btnBack.onclick = () => {
  if (currentContext === "root") return;

  const u = kernel.getUnit(currentContext);
  currentContext = u?.parentId || "root";

  if (currentContext === "root") {
    currentId = null;
    title.value = "";
    editor.value = "";
  } else {
    currentId = currentContext;
  }

  render();
};

btnHistory.onclick = () => {
  location.href = currentId
    ? `history.html?unit=${encodeURIComponent(currentId)}`
    : "history.html";
};

btnNew.onclick = () => {
  const u = kernel.createUnit({ title: "Nova Nota", context: currentContext });
  open(u.id);
};

btnArchive.onclick = () => {
  if (!currentId) return;
  const u = kernel.getUnit(currentId);
  kernel.changeState(currentId, u.state === "ARQUIVADO" ? "ATIVO" : "ARQUIVADO");
  open(currentId);
};

btnDelete.onclick = () => {
  if (!currentId) return;
  if (confirm("Excluir definitivamente?")) {
    kernel.deleteUnit(currentId);
    currentId = null;
    currentContext = "root";
    title.value = "";
    editor.value = "";
    render();
  }
};

let saveTimer = null;
function scheduleSave(data) {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    if (currentId) kernel.updateUnit(currentId, data);
  }, 400);
}

title.oninput = () => scheduleSave({ title: title.value });
editor.oninput = () => scheduleSave({ content: editor.value });

search.oninput = () => {
  searchQuery = search.value;
  render();
};

sort.onchange = () => {
  sortMode = sort.value;
  render();
};

function renderLastEditedUnit() {
  const el = document.getElementById("ctx-last-edited");
  if (!el) return;

  const id = localStorage.getItem(STORAGE_LAST_EDITED);
  if (!id) {
    el.textContent = "—";
    return;
  }

  const u = kernel.getUnit(id);
  if (!u) {
    el.textContent = "(removida)";
    return;
  }

  const path =
    kernel.getPath ? kernel.getPath(u.id).join(" › ") : (u.title || "(sem título)");

  el.innerHTML = `
    <div><strong>${u.title || "(sem título)"}</strong></div>
    <div style="font-size:11px;color:#888">${path}</div>
    <div style="font-size:11px;color:#666">
      Última edição: ${new Date(u.updatedAt).toLocaleString()}
    </div>
  `;
}

/* --- BOOT: ROOT COM CONTEXTO PASSIVO --- */
currentContext = "root";
currentId = null;
renderLastEditedUnit();

/* hidrata CONTEXTO PASSIVO no ROOT */
(function hydratePassiveContextFromLastEdited() {
  const id = localStorage.getItem(STORAGE_LAST_EDITED);
  if (!id) return;
  const u = kernel.getUnit(id);
  if (!u) return;
  renderContextPanel(u);
})();

render();
</script>

</body>
</html>
